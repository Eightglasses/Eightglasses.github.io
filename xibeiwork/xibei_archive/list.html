<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/xibei_archive.css">
    <script src="js/rem.min.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
</head>

<body>

    <div class="archive_header">
        <span class="back"></span>
        <div class="archive_header_search">
            <input type="text">
            <span class="clear"></span>
        </div>
        <p class="archive_header_right">搜索</p>
    </div>
    <div class="wrap gray">
        <div class="archive_list_title">
            <span></span>
            <p>当前共100条记录</p>
            <span></span>
        </div>
        <div class="status" style="display: none">数据加载中</div>
        <div class="archive_list">
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
            <div class="archive_li">
                <div class="archive_li1">
                    <p>机器维修档案</p>
                    <span>详情</span>
                </div>
                <div class="archive_li2">
                    <p>提交门店：</p>
                    <span>重庆万象城店</span>
                </div>
                <div class="archive_li2">
                    <p>更新时间：</p>
                    <span>2019/06/10 23:59:32</span>
                </div>
            </div>
        </div>
        <div class="archive_list_nodata" style="display: none">
            <span class="nodata_bg"></span>
            <p>未搜索到相关内容</p>
        </div>
        <div class="archive_list_tab">
            <div class="archive_list_tab_li active">
                <span class="icon_ht"></span>
                <p>合同类</p>
            </div>
            <div class="archive_list_tab_li">
                <span class="icon_zx"></span>
                <p>装修类</p>
            </div>
        </div>
    </div>

</body>

</html>

<script>
    $(function () {
        load(true);
    })
    //
    // $(".wrap").scroll(function () {
    //     clearTimeout(this.timer);
    //     this.timer = setTimeout(function () {
    //         var scrollTop = $(".wrap").scrollTop();
    //         var offsetTop = $(".wrap").offset().top;
    //         var height = $(".wrap").height();
    //         if (scrollTop + offsetTop > height) {
    //             //alert('111');
    //             load(true);
    //         }
    //     }, 200);
    // });----------------------------------

    // $(window).scroll(function () {
    //     var scrollTop = $(this).scrollTop();
    //     var scrollHeight = $(document).height();
    //     var windowHeight = $(this).height();
    //
    //     // if (scrollTop === 0) {
    //     //     load(false);
    //     // }
    //
    //     console.log(scrollTop,scrollHeight,windowHeight)
    //     if (scrollTop + windowHeight == scrollHeight) {
    //         //加载数据的函数
    //         load(true);
    //     }
    // });


    //定义的全局变量
    var disY, startY, endY;
    //触摸事件开始时触发
    $('.wrap').on('touchstart', function (e) {
        startY = e.changedTouches[0].pageY;
    });

    // //触摸事件移动中时触发
    $('.wrap').on('touchmove', function (e) {
        endY = e.changedTouches[0].pageY;
        disY = endY - startY;
        console.log(disY)
        if (disY > 30) {
            $('.status').css({
                display: 'block',
                height: disY + 'px',
            });
        }
    });

    //触摸事件结束时触发
    $('.wrap').on('touchend', function (e) {
        endY = e.changedTouches[0].pageY;
        disY = endY - startY;
        if (disY > 72) {
            //定义一个定时器，返回下拉到一定的高度
            // var timer = setInterval(function () {
                disY -= 13;
                if (disY <= 60) {
                    // clearInterval(timer);
                    load(false)
                }
                $('.status').css({
                    height: 0,
                    display: 'none',
                });
            // }, 10);
        }
    });

    function getScrollTop() {
        var scrollTop = 0;
        if (document.documentElement && document.documentElement.scrollTop) {
            scrollTop = document.documentElement.scrollTop;
        } else if (document.body) {
            scrollTop = document.body.scrollTop;
        }
        return scrollTop;
    }

    //获取当前可视范围的高度
    function getClientHeight() {
        var clientHeight = 0;
        if (document.body.clientHeight && document.documentElement.clientHeight) {
            clientHeight = Math.min(document.body.clientHeight, document.documentElement.clientHeight);
        } else {
            clientHeight = Math.max(document.body.clientHeight, document.documentElement.clientHeight);
        }
        return clientHeight;
    }

    //获取文档完整的高度
    function getScrollHeight() {
        return Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
    }

    //滚动事件触发
    window.onscroll = function () {
        if (getScrollTop() + getClientHeight() === getScrollHeight()) {
            load(true)
        }
    };


    $('.archive_header_search').find('.clear').click(function () {
        if ($('input[name="search-title"]').val() !== '') {
            $('input[name="search-title"]').val('');
        }
        load(false);
    })

    $('.archive_list_tab_li').click(function () {
        if (!$(this).hasClass('active')) {
            $(this).addClass('active');
            var type = $(this).data('type');
            var container = $('.type_' + type);
            container.show();
            container.siblings('.archive_list').hide();
            $(this).siblings().removeClass('active');
            $('input[name="search-title"]').val('');

            load(false);
        }
    });

    $('.archive_header_right').click(function () {
        load(false);
        $('.archive_list_nodata').find('p').html('未搜索到相关内容');
    });


    function load(append) {
        var cat = $('.archive_list_tab').find('.active').data('type');
        var container = $('.type_' + cat);
        var empty = $('.archive_list_nodata');
        var header = $('.archive_list_title');
        var page = 1;
        if (append) {
            page = container.attr('data-page');
        }
        var title = $('input[name="search-title"]').val();
        $.post(common.archive_list, { cat: cat, page: page, title: title }, function (response) {

            if (response.code == 1) {
                var data = response.data;
                var listHtml = '';
                header.find('p').html('当前共' + data.total.toString() + '条记录');
                var archiveList = data.list;
                for (var i = 0, len = archiveList.length; i < len; i++) {
                    var editUrl = common.update_archive_url + '?ar_id=' + archiveList[i].ar_id;
                    listHtml += ' <div class="archive_li" data-url="' + editUrl + '">' +
                        '<div class="archive_li1">' +
                        '<p>' + archiveList[i].title + '</p>' +
                        '<span><a href="' + editUrl + '">详情</a></span></div>' +
                        '<div class="archive_li2">' +
                        '<p>提交门店：</p>' +
                        '<span>' + archiveList[i].store_name + '</span>' +
                        '</div>' +
                        '<div class="archive_li2">' +
                        '<p>更新时间：</p>' +
                        '<span>' + archiveList[i].update_time + '</span>' +
                        '</div></div>';
                }
                container.show();
                header.show();
                empty.hide();
                if (append) {
                    container.append(listHtml);
                } else {
                    if (listHtml === '') {
                        empty.show();
                        container.hide();
                        header.hide();
                    } else {
                        container.html(listHtml);
                    }

                }
                $('.archive_li').click(function () {
                    location.href = $(this).data('url');
                })
                if (append) {
                    container.attr('data-page', parseInt(page) + 1);
                } else {
                    container.attr('data-page', '2');
                }

            }
        })

        empty.find('p').html('没有相关内容');
    }

</script>